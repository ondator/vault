# Аутентификация 2. Службы каталогов AD, kerberos & ldap
## Службы каталогов и AD
В каждой организации стремятся управлять правами и полномочиями своих сотрудников централизовано по всему ландшафту. Для автоматизации этого процесса придумали много различных IDM систем, но так или иначе под ними всегда лежит некая служба каталогов (Directory Service или просто DS). Не смотря на то, что основные принципы и протоколы DS сформировались еще в начале 90х, повсеместное распространение DS получил в районе 2000 года с рождением Microsoft ActiveDirectory (AD), который мы и рассмотрим, т.к. остальные службы каталогов мне либо не встречались (RedHat и Sun) либо имеют службу эмуляции AD (Novell eDirectory)
Основным элементом AD является домен (DC), например mydomain.com. При этом, у домена могут быть поддомены, например a.mydomain.com и b.mydomain.com. Вместе вся эта конструкция называется деревом. Но и это еще не все! В одном AD можно создавать несколько деревьев доменов, в результате чего получится доменный лес (forest). Лес в одной инстанции AD может быть только один. Если необходимо создать новый лес, то придется поднимать новый контроллер AD.
>>> Часто домены хочется подружить между собой, что бы ?? для этого можно создавать доверительные отношения между доменами

Внутри домена может лежать все что угодно: пользователи, принтеры, рабочие станции, тех. учетки(gMSA) и еще много всего интересного, но мы тут про авторизацию, так что ограничимся пользователями, группами и контейнерами. Во первых, стоит сказать, что домен AD имеет иерархическую структуру. В DC может лежать несколько орг. едениц(OU), в которых, в свою очередь, тоже могут лежать другие OU, но так же могут находиться и пользователи. При этом каждый пользователь (как, на самом деле и OU) получает свой уникальный путь (Distinguished Name или просто DN), например CN=Bob,OU=MF,OU=IT Department,DC=mydomain,DC=com. 
У каждого пользователя может быть достаточно большой набор различных аттрибутов как стандартных, так и не очень. Вот несколько полезных стандартных аттрибутов

| Аттрибут | описание | пример |
| --- | --- | ---- |
| distinguishedName | полный путь к пользователю в каталоге | CN=Bob,OU=MF,OU=IT Department,DC=mydomain,DC=com |
| userPrincipalName | полное имя пользователя с доменом | bob@mydomain.com |
| sAMAccountName | полное имя пользователя без домена | bob |
| memberOf | группы пользователя. Может иметь несколько значений | CN=My Awesome Group,OU=Groups,DC=mydomain,DC=com |
| givenName | Имя пользователя | Bob |
| sn | Фамилия пользователя | Smith |
| displayName | Тут содержится информация о том, как обращаться к пользователю. Чаще всего это ФИО | Bob Jason Smith |
| title | Должность пользователя | Project Manager |
| mail | Почта | bob.smith@mydomain.com |

Помимо этого, у пользователя есть extensionAttribute0-15, которые можно использовать на свое усмотрение, а так же можно создавать собственные атрибуты (правда удалить их потом не получится)
## LDAP
Для того, что бы доступиться к этому великолепию используется протокол LDAP. LDAP -- это специальный протокол, который предназначен для того, что бы предоставлять стандартный интерфейс ко всем службам каталогов. На данный момент, как и любой уважающий себя протокол может работать over SSL(LDAPS). LDAP имеет несколько операций для полноценной работы с каталогом, но мы тут про аутентификацию, так что все мы рассматривать не будем. Посмотрим на 2: search и bind

### bind
Bind -- это простейшая операция аутентификации встроенная в LDAP протокол. Имеются 2 опции -- SASL и simple(по логину-паролю). Если аутентификация прошла успешно, то приходит success результат с кодом 0. Если не успешно, то приходит ошибка, из которых самая интересная - 49 (InvalidCredentials). В случае AD вместе с ней приходят и поясненительные коды в поле data, например 52e (пользователь с нужным DN есть, но пароль не верный). На самом деле, наличие такой ошибки -- это все, что нужно знать про безопасность LDAP bind, но если хотите преисполниться еще, то [вот](https://habr.com/ru/companies/avanpost/articles/484186/) целая статья про то, почему никогда не надо использовать LDAP bind даже для аутентификации внутри КСПД(intranet). Тем не менее, для всех сторонних систем аутентификации использующих AD как мастер-систему по управлению пользователями и полномочиями, LDAP bind -- необходимое зло. В этом случае, рекомендуется вооружиться хорошими файрволами и организовать доступ до LDAP только той системе, которой он действительно необходим, а для всех остальных, мы чуть дальше поговорим о Kerberos

### Search
Search - 
#### основные сценарии
#### безопасность
LDAP стандартно использует для связи с LDAP-сервером порт 389. Если используется LDAPS(LDAP over SSL), то порт меняется на 636